= GlobalProtect OpenConnect Operator's Guide
:doctype: book
:toc: left
:toclevels: 3
:sectlinks:
:sectanchors:
:numbered:
:source-highlighter: highlight.js
:icons: font
:imagesdir: images
:version: 2.4.4
:author: GlobalProtect OpenConnect Team
:email: k3vinyue@gmail.com
:revdate: {localdate}

[preface]
== Preface

This operator's guide provides comprehensive documentation for deploying, configuring, and maintaining GlobalProtect OpenConnect in production environments. It covers installation, configuration, monitoring, and troubleshooting procedures for system administrators and DevOps engineers.

== Introduction

GlobalProtect OpenConnect is a VPN client solution that provides secure connectivity to GlobalProtect-enabled VPN servers. This guide focuses on production deployment and operational procedures for the CLI components, which are fully tested and production-ready.

=== Target Audience

This guide is designed for:
* **System Administrators**: Managing VPN client deployments
* **DevOps Engineers**: Integrating VPN clients into automation workflows
* **IT Operations**: Supporting end-user VPN connectivity
* **Security Teams**: Implementing secure VPN access policies

=== Scope

This guide covers:
* Installation and deployment procedures
* Configuration management
* User management and authentication
* Monitoring and logging
* Troubleshooting and maintenance
* Security considerations
* Performance optimization

include::sects/project-overview.adoc[leveloffset=+2]

include::sects/architecture-overview.adoc[leveloffset=+2]

include::sects/component-descriptions.adoc[leveloffset=+2]

include::sects/network-architecture.adoc[leveloffset=+2]

== Installation and Deployment

include::sects/system-requirements.adoc[leveloffset=+2]

=== Installation Methods

NOTE: This guide focuses on CLI components which are production-ready and work on all systems. GUI components require additional WebKit dependencies not available in conda-forge. For GUI installation, see the WebKit Dependencies Status section below.

In each case the installation can be verified using the following commands:

[source,bash]
----
# Verify installation
gpclient --version
gpservice --version
gpauth --version
----

==== Conda Package Installation (Recommended)

The preferred installation method uses conda packages:

[source,bash]
----
# Install from conda-forge (when available)
conda install -c conda-forge globalprotect-openconnect-cli

# Install from local package
conda install ./globalprotect-openconnect-cli-2.4.4-hb0f4dca_0.conda
----

==== Pixi Installation Method

For detailed pixi installation instructions, see: link:helper_pixi_install.adoc[Pixi Installation Guide]

**Install from conda-forge (when available)**

[source,bash]
----
# Install GlobalProtect CLI globally
pixi global install -c conda-forge globalprotect-openconnect-cli
----

NOTE: This installs CLI components only. For GUI support on Fedora Silverblue/Bluefin, install webkit system packages first: `sudo rpm-ostree install webkit2gtk4.1-devel gtk3-devel cairo-devel gdk-pixbuf2-devel pango-devel`

**Install from local conda package**

[source,bash]
----
# Install from local conda package file (must provide full path, relative paths are not yet supported)
pixi global install $(pwd)/globalprotect-openconnect-cli-2.4.4-hb0f4dca_0.conda
----

==== Binary Installation

For systems without conda:

[source,bash]
----
# Download and extract binaries
wget https://github.com/yuezk/GlobalProtect-openconnect/releases/latest/download/gp-cli-linux.tar.gz
tar -xzf gp-cli-linux.tar.gz

# Install to system path
sudo cp gpclient gpservice gpauth /usr/local/bin/
sudo chmod +x /usr/local/bin/gp*

# Create configuration directory
sudo mkdir -p /etc/globalprotect
----

==== Container Deployment

Deploy using containers:

[source,dockerfile]
----
# Dockerfile
FROM condaforge/mambaforge:latest

# Install GlobalProtect CLI
RUN mamba install -c conda-forge globalprotect-openconnect-cli

# Configure entrypoint
COPY entrypoint.sh /usr/local/bin/
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
----

[source,bash]
----
# Build and deploy
docker build -t globalprotect-cli .
docker run -d --name vpn-client \
  --cap-add=NET_ADMIN \
  --device=/dev/net/tun \
  -v /etc/globalprotect:/etc/globalprotect:ro \
  globalprotect-cli
----

==== Package Manager Installation

Distribution-specific packages:

[source,bash]
----
# Ubuntu/Debian (when available)
sudo apt update
sudo apt install globalprotect-openconnect

# RHEL/CentOS/Fedora (when available)
sudo dnf install globalprotect-openconnect

# Arch Linux (AUR)
yay -S globalprotect-openconnect-git
----

=== Post-Installation Configuration

==== Conda Package Configuration Tools

For conda package installations, automated configuration tools are included to simplify setup:

===== Automated Setup Script (`gp-setup`)

The `gp-setup` script automates system configuration based on best practices:

[source,bash]
----
# Complete automated setup (recommended)
gp-setup --all

# Check current configuration status
gp-setup --check

# Individual setup components
gp-setup --url-handler     # Browser authentication setup
gp-setup --runtime-dirs    # Runtime directory configuration
gp-setup --permissions     # File permission fixes
gp-setup --flatpak         # Flatpak browser configuration

# System-wide setup (requires root)
sudo gp-setup --system

# Remove all configuration
gp-setup --uninstall
----

**Key Features:**
* **URL Scheme Handler Setup**: Configures `globalprotectcallback://` for browser authentication
* **Runtime Directory Management**: Uses appropriate directories based on user privileges
* **Permission Management**: Ensures proper file permissions and directory access
* **Flatpak Browser Support**: Configures permissions for sandboxed browsers
* **Multi-user Isolation**: Separate configurations for different users

===== Welcome and Guidance (`gp-welcome`)

Interactive welcome screen with setup guidance:

[source,bash]
----
# Show complete welcome screen
gp-welcome

# Show only setup status
gp-welcome --status

# Show configuration tips
gp-welcome --tips

# Show environment information
gp-welcome --env
----

===== Installation Verification

Verify conda package installation:

[source,bash]
----
# Basic verification - check if all commands are available
gpclient --version
gpservice --version
gpauth --version
gp-setup --help
gp-welcome --help

# Comprehensive verification (if available)
./packaging/verify-installation.sh

# Check setup status
gp-setup --check
----

===== Configuration Workflow

**For New Installations:**

[source,bash]
----
# 1. Install package
conda install -c conda-forge globalprotect-openconnect

# 2. View welcome and setup status
gp-welcome

# 3. Run automated setup
gp-setup --all

# 4. Verify configuration
gp-setup --check

# 5. Test authentication
gpauth --browser default your-vpn-server.com
----

**Troubleshooting Configuration Issues:**

[source,bash]
----
# Diagnose issues
gp-setup --check

# Fix common problems
gp-setup --permissions      # Permission errors
gp-setup --url-handler      # Browser authentication hangs
gp-setup --flatpak          # Flatpak browser issues

# Complete reconfiguration
gp-setup --uninstall
gp-setup --all
----

==== System Integration

Configure system integration:

[source,bash]
----
# Create systemd service
sudo tee /etc/systemd/system/globalprotect.service << EOF
[Unit]
Description=GlobalProtect VPN Service
After=network.target
Wants=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/gpservice
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
sudo systemctl enable globalprotect
sudo systemctl start globalprotect

# Verify service is running
sudo systemctl status globalprotect

# Test service functionality
sleep 5
gpclient status
----

=== Installation Verification

After installation, verify that GlobalProtect OpenConnect is working correctly:

==== Basic Verification

[source,bash]
----
# Check binary installation
which gpclient gpservice gpauth

# Verify version information
gpclient --version
gpservice --version
gpauth --version

# Test help functionality
gpclient --help
gpauth --help
----



==== Service Verification

[source,bash]
----
# Check service status
sudo systemctl status globalprotect

# Verify service logs
journalctl -u globalprotect --lines=20

# Test service communication
gpservice --help
----

==== Dependency Verification

[source,bash]
----
# Check OpenConnect availability
openconnect --version

# Verify SSL libraries
ldd $(which gpclient) | grep -E "(ssl|crypto|openconnect)"

# Test network connectivity requirements
ping -c 3 8.8.8.8
----

==== Network Configuration

Configure network policies:

[source,bash]
----
# Allow VPN traffic through firewall
sudo ufw allow out 443/tcp comment "GlobalProtect HTTPS"
sudo ufw allow out 4501/udp comment "GlobalProtect IPSec"

# Configure routing (if needed)
echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
----

include::sects/webkit-status.adoc[leveloffset=+1]

== Configuration Management

=== Configuration Files

GlobalProtect OpenConnect uses several configuration files:

==== Main Configuration

Location: `/etc/globalprotect/gp.conf`

[source,ini]
----
[connection]
# VPN server configuration
server = vpn.company.com
gateway = gateway1.company.com
user = ${USER}

[authentication]
# Authentication settings
method = saml
browser = default
user-agent = PAN GlobalProtect

[network]
# Network configuration
interface = gpd0
mtu = 1400
disable-ipv6 = false

[security]
# Security settings
certificate = /etc/globalprotect/client.pem
key = /etc/globalprotect/client.key
ignore-tls-errors = false

[logging]
# Logging configuration
level = info
file = /var/log/globalprotect.log

[runtime]
# Runtime directory configuration (automatic)
# For root users: /var/run/
# For non-root users: $XDG_RUNTIME_DIR or ~/.local/state/globalprotect/
----

==== User Configuration

Location: `~/.config/globalprotect/config.toml`

[source,toml]
----
[user]
# User-specific settings
username = "user@company.com"
save_credentials = false
auto_connect = true

[servers]
# Server profiles
[servers.corporate]
name = "Corporate VPN"
server = "vpn.company.com"
gateway = "gateway1.company.com"

[servers.backup]
name = "Backup VPN"
server = "vpn-backup.company.com"
gateway = "gateway2.company.com"

[preferences]
# User preferences
minimize_to_tray = true
start_on_boot = false
notifications = true
----

==== Environment Configuration

Environment variables for configuration:

[source,bash]
----
# System-wide configuration
export GP_SERVER="vpn.company.com"
export GP_USER="user@company.com"
export GP_BROWSER="firefox"
export GP_LOG_LEVEL="info"

# Security settings
export GP_IGNORE_TLS_ERRORS="false"
export GP_USE_SYSTEM_CERT_STORE="true"
----

**Note**: If using flatpak browsers, set the browser environment variable to the full flatpak command:

[source,bash]
----
# For flatpak Firefox
export GP_BROWSER="flatpak run org.mozilla.firefox"

# For flatpak Opera
export GP_BROWSER="flatpak run com.opera.Opera"
----

=== Runtime Directory and File Permissions

GlobalProtect OpenConnect automatically handles runtime directories and file permissions based on user privileges:

==== Runtime Directory Selection

[source,bash]
----
# For root users (system-wide deployment)
/var/run/gpservice.lock       # Service lock file
/var/run/gpclient.lock        # Client lock file
/tmp/gpservice_disconnected.pid  # Disconnect status

# For non-root users (user deployment)
$XDG_RUNTIME_DIR/gpservice.lock              # Preferred location
~/.local/state/globalprotect/gpservice.lock  # Fallback location
$XDG_RUNTIME_DIR/gpservice_disconnected.pid  # Disconnect status
----

==== Permission Requirements

[source,bash]
----
# Check current runtime configuration
gpservice --version  # Shows runtime directory selection
gpclient --version   # Shows runtime directory selection

# Manual verification of permissions
ls -la /var/run/gp*                          # For root deployment
ls -la $XDG_RUNTIME_DIR/gp*                  # For user deployment
ls -la ~/.local/state/globalprotect/         # For user fallback

# Directory creation (automatic, but manual if needed)
mkdir -p ~/.local/state/globalprotect/
chmod 700 ~/.local/state/globalprotect/
----

==== Troubleshooting Permission Issues

[source,bash]
----
# Common permission errors and solutions

# Error: "Cannot access lock file: No write permission"
# Solution: Ensure proper runtime directory access
mkdir -p ~/.local/state/globalprotect/
chmod 700 ~/.local/state/globalprotect/

# Error: "Another instance is already running" (false positive)
# Solution: Check and clean stale lock files
rm -f ~/.local/state/globalprotect/*.lock
rm -f $XDG_RUNTIME_DIR/gp*.lock

# For system deployment with sudo
sudo mkdir -p /var/run/
sudo chown root:root /var/run/gp*.lock
----

**Note**: The runtime directory selection is automatic and transparent to users. Root users will use system directories (`/var/run/`), while non-root users will use user-specific directories for security and multi-user support.

=== Automated Configuration Management (Conda Package)

For conda package installations, automated configuration tools simplify deployment and maintenance:

==== Configuration Script Overview

[source,bash]
----
# Complete automated configuration
gp-setup --all

# Individual configuration components
gp-setup --url-handler         # Browser authentication setup
gp-setup --runtime-dirs        # Runtime directory configuration
gp-setup --permissions         # File permission management
gp-setup --flatpak             # Flatpak browser configuration

# Configuration verification
gp-setup --check               # Show current configuration status
gp-welcome --status             # Show setup status with guidance
----

==== Configuration Automation Features

**URL Scheme Handler Management:**
[source,bash]
----
# Automatic desktop file creation and registration
gp-setup --url-handler

# Verifies globalprotectcallback:// URL scheme registration
# Creates ~/.local/share/applications/gpclient-callback.desktop
# Registers with system MIME database
# Validates registration success
----

**Runtime Directory Automation:**
[source,bash]
----
# Automatic directory selection and creation
gp-setup --runtime-dirs

# For root users: /var/run/
# For regular users: $XDG_RUNTIME_DIR or ~/.local/state/globalprotect/
# Sets proper permissions (700 for user dirs, 755 for system dirs)
# Creates parent directories as needed
----

**Permission Management:**
[source,bash]
----
# Automatic permission fixing and validation
gp-setup --permissions

# Validates write access before operations
# Creates directories with proper permissions
# Cleans stale lock files
# Provides actionable error messages
----

**Flatpak Browser Integration:**
[source,bash]
----
# Automatic Flatpak browser configuration
gp-setup --flatpak

# Detects installed Flatpak browsers
# Grants network and filesystem permissions
# Configures localhost access
# Provides Flatseal guidance for advanced permissions
----

==== Deployment Workflow

**Enterprise Deployment:**
[source,bash]
----
# 1. Install package via conda
conda install -c conda-forge globalprotect-openconnect

# 2. Run welcome screen for status overview
gp-welcome

# 3. Automated configuration for all users
for user_home in /home/*; do
  sudo -u "$(basename "$user_home")" gp-setup --all
done

# 4. System-wide configuration (if needed)
sudo gp-setup --system

# 5. Verification
gp-setup --check
----

**User Self-Service:**
[source,bash]
----
# Simple user setup process
gp-setup --all                    # Complete automated setup
gp-welcome                        # Show status and next steps
gpauth --browser default server   # Test authentication
gpclient connect server           # Connect to VPN
----

==== Configuration Validation

[source,bash]
----
# Comprehensive configuration check
gp-setup --check

# Output includes:
# - Binary availability and versions
# - URL scheme handler registration
# - Runtime directory configuration
# - Browser detection and availability
# - Flatpak environment status
# - Permission validation
# - Environment information
----

=== Configuration Templates

==== Enterprise Configuration Template

[source,ini]
----
# Enterprise GlobalProtect Configuration
# /etc/globalprotect/gp-enterprise.conf

[connection]
server = {{ vpn_server }}
gateway = {{ vpn_gateway }}
user = {{ username }}
reconnect-timeout = 300

[authentication]
method = saml
browser = {{ browser_path }}
user-agent = {{ user_agent }}
os = Linux

[network]
interface = gpd0
mtu = {{ mtu | default(1400) }}
disable-ipv6 = {{ disable_ipv6 | default(false) }}
dns-servers = {{ dns_servers }}

[security]
certificate = {{ cert_path }}
key = {{ key_path }}
ca-certificate = {{ ca_cert_path }}
ignore-tls-errors = {{ ignore_tls | default(false) }}

[logging]
level = {{ log_level | default("info") }}
file = {{ log_file | default("/var/log/globalprotect.log") }}
max-size = {{ log_max_size | default("10MB") }}
max-files = {{ log_max_files | default(5) }}

[policy]
enforce-host-checker = {{ enforce_hc | default(true) }}
allow-local-lan = {{ allow_lan | default(false) }}
split-tunneling = {{ split_tunnel | default(false) }}
----

==== Development Configuration Template

[source,ini]
----
# Development GlobalProtect Configuration
# ~/.config/globalprotect/dev.conf

[connection]
server = dev-vpn.company.com
gateway = dev-gateway.company.com
user = dev-user@company.com

[authentication]
method = password
browser = chromium
user-agent = PAN GlobalProtect Dev

[network]
interface = gpd0
mtu = 1400
disable-ipv6 = false

[security]
ignore-tls-errors = true
fix-openssl = true

[logging]
level = debug
file = ~/.local/share/globalprotect/debug.log

[development]
verbose = true
debug-packets = false
save-traffic = false
----

== User Management and Authentication

=== Authentication Methods

GlobalProtect OpenConnect supports multiple authentication methods:

==== SAML/SSO Authentication

SAML-based single sign-on:

[source,bash]
----
# Configure SAML authentication
gpauth --saml-request="<saml_request>" vpn.company.com

# Interactive SAML authentication
gpauth --browser=firefox vpn.company.com

# Headless SAML authentication
gpauth --browser=none --saml-file=/tmp/saml.xml vpn.company.com
----

**Note for Flatpak Browser Users**: If you have browsers installed as flatpaks (Firefox, Opera, etc.), you may need to configure permissions for localhost access:

[source,bash]
----
# Check if browsers are flatpaks
flatpak list | grep -i firefox

# Install Flatseal for permission management
flatpak install flathub com.github.tchx84.Flatseal

# Configure flatpak browser permissions:
# 1. Open Flatseal
# 2. Select your browser (org.mozilla.firefox, com.opera.Opera)
# 3. Under "Socket" section, ensure "Network" is enabled
# 4. Under "Filesystem" section, add "host" if needed

# Alternative: Use explicit flatpak command
gpauth --browser "flatpak run org.mozilla.firefox" vpn.company.com
----

**URL Scheme Handler Setup**: For proper browser-based authentication, the `globalprotectcallback:` URL scheme must be registered with your desktop environment:

[source,bash]
----
# Create URL scheme handler desktop file
mkdir -p ~/.local/share/applications

cat > ~/.local/share/applications/gpclient-callback.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=GlobalProtect Callback Handler
Comment=Handler for GlobalProtect authentication callbacks
Exec=/usr/bin/gpclient launch-gui %u
MimeType=x-scheme-handler/globalprotectcallback;
NoDisplay=true
StartupNotify=false
Categories=Network;
EOF

# Update desktop database and register scheme
update-desktop-database ~/.local/share/applications/
xdg-mime default gpclient-callback.desktop x-scheme-handler/globalprotectcallback

# Verify registration
xdg-mime query default x-scheme-handler/globalprotectcallback

# For custom installation paths, update the Exec line in the desktop file:
# Exec=/path/to/custom/gpclient launch-gui %u
----

**Note**: This setup is required for browser authentication to work properly in most desktop environments, especially when using Flatpak or other sandboxed applications.

==== Certificate-Based Authentication

Client certificate authentication:

[source,bash]
----
# Certificate authentication
gpclient connect \
  --certificate /path/to/client.pem \
  --key /path/to/client.key \
  --key-password "password" \
  vpn.company.com
----

==== Multi-Factor Authentication

MFA integration:

[source,bash]
----
# MFA with TOTP
gpauth --mfa-method=totp vpn.company.com

# MFA with push notification
gpauth --mfa-method=push vpn.company.com
----

=== User Provisioning

==== Automated User Setup

Script for automated user provisioning:

[source,bash]
----
#!/bin/bash
# provision-user.sh

USER_EMAIL="$1"
USER_CERT="$2"
VPN_SERVER="$3"

# Create user configuration
mkdir -p ~/.config/globalprotect

cat > ~/.config/globalprotect/config.toml << EOF
[user]
username = "${USER_EMAIL}"
certificate = "${USER_CERT}"

[servers.default]
server = "${VPN_SERVER}"
gateway = "auto"
EOF

# Set appropriate permissions
chmod 600 ~/.config/globalprotect/config.toml

echo "User ${USER_EMAIL} provisioned for VPN server ${VPN_SERVER}"
----

==== Bulk User Management

Bulk provisioning script:

[source,bash]
----
#!/bin/bash
# bulk-provision.sh

USER_LIST="$1"
VPN_SERVER="$2"
CERT_DIR="$3"

while IFS=, read -r username email department; do
  echo "Provisioning user: $username ($email)"

  # Create user-specific certificate
  CERT_FILE="${CERT_DIR}/${username}.pem"

  # Run provisioning
  ./provision-user.sh "$email" "$CERT_FILE" "$VPN_SERVER"

  echo "User $username provisioned successfully"
done < "$USER_LIST"
----

=== Access Control

==== Role-Based Access Control

Configure role-based VPN access:

[source,yaml]
----
# rbac-config.yaml
roles:
  - name: admin
    permissions:
      - vpn:connect:*
      - vpn:manage:users
      - vpn:view:logs
    gateways:
      - admin.vpn.company.com
      - mgmt.vpn.company.com

  - name: developer
    permissions:
      - vpn:connect:dev
      - vpn:connect:staging
    gateways:
      - dev.vpn.company.com
      - staging.vpn.company.com

  - name: employee
    permissions:
      - vpn:connect:corporate
    gateways:
      - corporate.vpn.company.com

users:
  - username: admin@company.com
    roles: [admin]
  - username: dev@company.com
    roles: [developer]
  - username: user@company.com
    roles: [employee]
----

==== Policy Enforcement

Implement access policies:

[source,bash]
----
#!/bin/bash
# enforce-policy.sh

USER="$1"
GATEWAY="$2"

# Check user permissions
check_user_access() {
  local user="$1"
  local gateway="$2"

  # Query LDAP/AD for user groups
  groups=$(ldapsearch -x -b "dc=company,dc=com" "(uid=$user)" memberOf)

  # Check gateway access rules
  case "$gateway" in
    "admin.vpn.company.com")
      echo "$groups" | grep -q "cn=vpn-admins" || {
        echo "Access denied: Admin gateway requires vpn-admins group"
        exit 1
      }
      ;;
    "dev.vpn.company.com")
      echo "$groups" | grep -q "cn=developers" || {
        echo "Access denied: Dev gateway requires developers group"
        exit 1
      }
      ;;
    *)
      echo "Access denied: Unknown gateway"
      exit 1
      ;;
  esac

  echo "Access granted for $user to $gateway"
}

check_user_access "$USER" "$GATEWAY"
----

== Monitoring and Logging

=== Logging Configuration

==== System Logging

Configure comprehensive logging:

[source,bash]
----
# Configure rsyslog for GlobalProtect
cat > /etc/rsyslog.d/50-globalprotect.conf << EOF
# GlobalProtect logging
if \$programname startswith 'gp' then /var/log/globalprotect.log
& stop
EOF

# Restart rsyslog
sudo systemctl restart rsyslog
----

==== Application Logging

Configure application-specific logging:

[source,bash]
----
# Set logging levels
export GP_LOG_LEVEL=info
export RUST_LOG=gpclient=debug,gpservice=info,gpauth=debug

# Configure log rotation
cat > /etc/logrotate.d/globalprotect << EOF
/var/log/globalprotect.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 root root
    postrotate
        systemctl reload globalprotect || true
    endscript
}
EOF
----

=== Monitoring Setup

==== Health Checks

Implement health monitoring:

[source,bash]
----
#!/bin/bash
# health-check.sh

# Check service status
check_service() {
  if systemctl is-active --quiet globalprotect; then
    echo "OK: GlobalProtect service is running"
    return 0
  else
    echo "CRITICAL: GlobalProtect service is not running"
    return 1
  fi
}

# Check VPN connectivity
check_connectivity() {
  if gpclient status | grep -q "Connected"; then
    echo "OK: VPN connection is active"
    return 0
  else
    echo "WARNING: VPN connection is not active"
    return 1
  fi
}

# Check tunnel interface
check_tunnel() {
  if ip link show gpd0 &>/dev/null; then
    echo "OK: VPN tunnel interface exists"
    return 0
  else
    echo "CRITICAL: VPN tunnel interface not found"
    return 1
  fi
}

# Run all checks
check_service
check_connectivity
check_tunnel
----

==== Metrics Collection

Configure metrics collection:

[source,bash]
----
#!/bin/bash
# collect-metrics.sh

# Connection metrics
CONNECTION_COUNT=$(gpclient status --json | jq '.active_connections | length')
CONNECTION_UPTIME=$(gpclient status --json | jq -r '.uptime')

# Traffic metrics
RX_BYTES=$(cat /sys/class/net/gpd0/statistics/rx_bytes 2>/dev/null || echo 0)
TX_BYTES=$(cat /sys/class/net/gpd0/statistics/tx_bytes 2>/dev/null || echo 0)

# Authentication metrics
AUTH_SUCCESS=$(grep "Authentication successful" /var/log/globalprotect.log | wc -l)
AUTH_FAILED=$(grep "Authentication failed" /var/log/globalprotect.log | wc -l)

# Output metrics in Prometheus format
cat << EOF
# HELP gp_connections_active Number of active VPN connections
# TYPE gp_connections_active gauge
gp_connections_active $CONNECTION_COUNT

# HELP gp_connection_uptime_seconds Connection uptime in seconds
# TYPE gp_connection_uptime_seconds gauge
gp_connection_uptime_seconds $CONNECTION_UPTIME

# HELP gp_traffic_rx_bytes_total Total received bytes
# TYPE gp_traffic_rx_bytes_total counter
gp_traffic_rx_bytes_total $RX_BYTES

# HELP gp_traffic_tx_bytes_total Total transmitted bytes
# TYPE gp_traffic_tx_bytes_total counter
gp_traffic_tx_bytes_total $TX_BYTES

# HELP gp_auth_success_total Total successful authentications
# TYPE gp_auth_success_total counter
gp_auth_success_total $AUTH_SUCCESS

# HELP gp_auth_failed_total Total failed authentications
# TYPE gp_auth_failed_total counter
gp_auth_failed_total $AUTH_FAILED
EOF
----

=== Alerting

==== Alert Rules

Configure monitoring alerts:

[source,yaml]
----
# alerts.yaml
groups:
  - name: globalprotect
    rules:
      - alert: GlobalProtectServiceDown
        expr: up{job="globalprotect"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "GlobalProtect service is down"
          description: "GlobalProtect service has been down for more than 1 minute"

      - alert: VPNConnectionDown
        expr: gp_connections_active == 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "VPN connection is down"
          description: "No active VPN connections for more than 5 minutes"

      - alert: HighAuthenticationFailures
        expr: rate(gp_auth_failed_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High authentication failure rate"
          description: "Authentication failure rate is {{ $value }} failures/second"

      - alert: TunnelInterfaceDown
        expr: node_network_up{device="gpd0"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "VPN tunnel interface is down"
          description: "VPN tunnel interface gpd0 is not available"
----

==== Notification Setup

Configure alert notifications:

[source,yaml]
----
# alertmanager.yaml
global:
  smtp_smarthost: 'smtp.company.com:587'
  smtp_from: 'alerts@company.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    email_configs:
      - to: 'ops-team@company.com'
        subject: 'GlobalProtect Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Labels: {{ range .Labels.SortedPairs }}{{ .Name }}={{ .Value }} {{ end }}
          {{ end }}

    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#ops-alerts'
        title: 'GlobalProtect Alert'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
----

== Troubleshooting and Maintenance

=== Common Issues

==== Connection Problems

**Issue**: Cannot establish VPN connection

**Diagnosis**:
[source,bash]
----
# Check system configuration (conda package)
gp-setup --check

# Check connectivity to VPN server
nslookup vpn.company.com
ping vpn.company.com
telnet vpn.company.com 443

# Check certificate validity
openssl s_client -connect vpn.company.com:443 -showcerts

# Verify authentication
gpauth --verbose vpn.company.com
----

**Solutions**:
[source,bash]
----
# Fix configuration issues (conda package)
gp-setup --permissions

# Reset network configuration
sudo ip route flush table main
sudo systemctl restart NetworkManager

# Clear authentication cache
rm -rf ~/.cache/globalprotect/
rm -rf ~/.config/globalprotect/auth/

# Restart service
sudo systemctl restart globalprotect
----

==== Authentication Issues

**Issue**: SAML authentication fails

**Diagnosis**:
[source,bash]
----
# Debug SAML flow
gpauth --verbose --browser=firefox vpn.company.com

# Check browser logs
journalctl -u globalprotect | grep -i saml

# Verify SAML response
cat /tmp/gp-saml-response.xml | xmllint --format -
----

**Solutions**:
[source,bash]
----
# Clear browser cache
rm -rf ~/.cache/mozilla/firefox/*/cache2/
rm -rf ~/.config/google-chrome/Default/Cache/

# Use different browser
gpauth --browser=chromium vpn.company.com

# Manual SAML handling
gpauth --saml-file=/path/to/response.xml vpn.company.com
----

**Issue**: Browser authentication fails with flatpak browsers (Firefox, Opera)

**Diagnosis**:
[source,bash]
----
# Check if browsers are installed as flatpaks
flatpak list | grep -i firefox
flatpak list | grep -i opera

# Test authentication with explicit browser
gpauth --verbose --browser default vpn.company.com
----

**Solutions**:
[source,bash]
----
# Option 1: Configure Flatseal permissions (Recommended)
# Install Flatseal if not available
flatpak install flathub com.github.tchx84.Flatseal

# Open Flatseal and for each flatpak browser:
# - Select the browser (org.mozilla.firefox, com.opera.Opera)
# - Under "Socket" section, ensure "Network" is enabled
# - Under "Filesystem" section, add "host" or "~/.local/share/" if needed

# Option 2: Use explicit flatpak command
gpauth --browser "flatpak run org.mozilla.firefox" vpn.company.com

# Option 3: Install native browser
sudo dnf install firefox  # For Fedora/RHEL
sudo apt install firefox  # For Ubuntu/Debian
----

**Issue**: Browser authentication completes but no output is returned from gpauth

**Diagnosis**:
[source,bash]
----
# Check if URL scheme handler is registered
xdg-mime query default x-scheme-handler/globalprotectcallback

# Test authentication with verbose logging
gpauth --verbose --browser default vpn.company.com

# Check for callback port file
ls -la /tmp/gpcallback*

# Verify desktop file exists
ls -la ~/.local/share/applications/*callback*
----

**Solutions**:
[source,bash]
----
# Option 1: Use automated setup script (conda package)
gp-setup --url-handler

# Option 2: Manual setup - Create local desktop file for URL scheme handler
mkdir -p ~/.local/share/applications

cat > ~/.local/share/applications/gpclient-callback.desktop << 'EOF'
[Desktop Entry]
Type=Application
Name=GlobalProtect Callback Handler
Comment=Handler for GlobalProtect authentication callbacks
Exec=/usr/bin/gpclient launch-gui %u
MimeType=x-scheme-handler/globalprotectcallback;
NoDisplay=true
StartupNotify=false
Categories=Network;
EOF

# Update desktop database
update-desktop-database ~/.local/share/applications/

# Register the URL scheme
xdg-mime default gpclient-callback.desktop x-scheme-handler/globalprotectcallback

# Verify registration
xdg-mime query default x-scheme-handler/globalprotectcallback

# For custom installation paths, update the Exec line:
# Exec=/path/to/gpclient launch-gui %u

# Test the fix
gpauth --browser default vpn.company.com
----

**Additional Flatpak/Sandbox Considerations**:
[source,bash]
----
# Option 1: Use automated Flatpak configuration (conda package)
gp-setup --flatpak

# Option 2: Manual Flatpak configuration
# If still having issues with sandboxed environments:
# 1. Use Flatseal to enable additional permissions:
#    - Network access (localhost communication)
#    - Filesystem access to /tmp and ~/.local/share/
#    - D-Bus session access
#    - Socket access for network communication

# 2. Alternative: Use explicit browser paths
gpauth --browser /usr/bin/firefox vpn.company.com

# 3. For AppImage or snap browsers, ensure proper permissions
snap connect firefox:network-observe
----

==== Performance Issues

**Issue**: Slow VPN performance

**Diagnosis**:
[source,bash]
----
# Check MTU settings
ip link show gpd0
ping -M do -s 1472 remote-server.com

# Monitor traffic
iftop -i gpd0
nethogs gpd0

# Check CPU usage
top -p $(pidof gpservice)
----

**Solutions**:
[source,bash]
----
# Optimize MTU
sudo ip link set dev gpd0 mtu 1200

# Enable compression
gpclient connect --compress vpn.company.com

# Disable IPv6 if not needed
echo 'net.ipv6.conf.all.disable_ipv6 = 1' | sudo tee -a /etc/sysctl.conf
----

=== Diagnostic Tools

==== Network Diagnostics

[source,bash]
----
#!/bin/bash
# network-diag.sh

echo "=== Network Diagnostic Report ==="
echo "Date: $(date)"
echo

echo "--- Interface Status ---"
ip addr show gpd0

echo "--- Routing Table ---"
ip route show

echo "--- DNS Configuration ---"
cat /etc/resolv.conf

echo "--- VPN Status ---"
gpclient status

echo "--- Connection Test ---"
ping -c 4 8.8.8.8
nslookup google.com

echo "--- Traffic Statistics ---"
cat /proc/net/dev | grep gpd0
----

==== Service Diagnostics

[source,bash]
----
#!/bin/bash
# service-diag.sh

echo "=== Service Diagnostic Report ==="
echo "Date: $(date)"
echo

echo "--- Service Status ---"
systemctl status globalprotect

echo "--- Process Information ---"
ps aux | grep -E "(gpclient|gpservice|gpauth)"

echo "--- Port Usage ---"
netstat -tulpn | grep -E "(gp|443|4501)"

echo "--- Recent Logs ---"
journalctl -u globalprotect --lines=50

echo "--- Configuration ---"
cat /etc/globalprotect/gp.conf

echo "--- Environment ---"
env | grep GP_
----

=== Maintenance Procedures

==== Regular Maintenance

Monthly maintenance checklist:

[source,bash]
----
#!/bin/bash
# monthly-maintenance.sh

echo "=== Monthly GlobalProtect Maintenance ==="

# Update software
echo "Updating GlobalProtect..."
conda update globalprotect-openconnect-cli

# Clean logs
echo "Cleaning old logs..."
find /var/log -name "*globalprotect*" -type f -mtime +30 -delete

# Check certificates
echo "Checking certificate expiration..."
for cert in /etc/globalprotect/certs/*.pem; do
  expiry=$(openssl x509 -in "$cert" -noout -enddate | cut -d= -f2)
  echo "Certificate $cert expires: $expiry"
done

# Verify configuration
echo "Verifying configuration..."
gpclient --config-check

# Test connectivity
echo "Testing VPN connectivity..."
timeout 30 gpclient test-connection

# Run comprehensive tests if available
if [ -f "tests/test_cli_final.sh" ]; then
  echo "Running comprehensive CLI tests..."
  ./tests/test_cli_final.sh
fi

echo "Maintenance completed: $(date)"
----

==== Updates and Patches

Update procedure:

[source,bash]
----
#!/bin/bash
# update-procedure.sh

# Backup current configuration
cp -r /etc/globalprotect /etc/globalprotect.backup.$(date +%Y%m%d)

# Stop service
sudo systemctl stop globalprotect

# Update package
conda update globalprotect-openconnect-cli

# Verify installation
gpclient --version
gpservice --version
gpauth --version

# Test configuration
gpclient --config-check

# Start service
sudo systemctl start globalprotect

# Verify functionality
sleep 10
gpclient status

# Run post-update tests
echo "Running post-update verification..."
gpclient --version
gpservice --version
gpauth --version

# Run comprehensive tests if available
if [ -f "tests/test_cli_final.sh" ]; then
  echo "Running comprehensive CLI tests..."
  ./tests/test_cli_final.sh
fi

echo "Update completed successfully"
----

== Security Considerations

=== Security Best Practices

==== Certificate Management

[source,bash]
----
# Generate client certificates
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -out client.crt

# Set proper permissions
chmod 600 /etc/globalprotect/certs/*.key
chmod 644 /etc/globalprotect/certs/*.crt
chown root:root /etc/globalprotect/certs/*
----

==== Access Control

[source,bash]
----
# Restrict configuration access
chmod 600 /etc/globalprotect/gp.conf
chown root:root /etc/globalprotect/gp.conf

# Limit user permissions
usermod -a -G vpn-users username

# Configure sudo access
echo "%vpn-users ALL=(root) NOPASSWD: /usr/local/bin/gpclient" > /etc/sudoers.d/globalprotect
----

==== Runtime File Security

GlobalProtect OpenConnect implements secure file handling with automatic permission management:

[source,bash]
----
# Automatic runtime directory security (handled by application)
# Root deployment - system-wide with proper ownership
/var/run/gpservice.lock (root:root, 644)
/var/run/gpclient.lock (root:root, 644)

# User deployment - user-specific with restricted access
$XDG_RUNTIME_DIR/gpservice.lock (user:user, 600)
~/.local/state/globalprotect/ (user:user, 700)

# Manual security verification
ls -la /var/run/gp*                    # System deployment
ls -la $XDG_RUNTIME_DIR/gp*            # User deployment
ls -la ~/.local/state/globalprotect/   # User fallback

# Security benefits:
# - Multi-user isolation: Users cannot interfere with each other's sessions
# - Privilege separation: Non-root users don't need system-wide write access
# - Automatic cleanup: User runtime directories are cleaned on logout
# - Permission validation: Applications check permissions before file operations
----

**Security Features**:
* **Automatic privilege detection**: Uses appropriate directories based on user context
* **Permission validation**: Checks file access before operations with clear error messages
* **Multi-user isolation**: Each user has separate runtime directories
* **Secure fallbacks**: Uses `~/.local/state/` when `XDG_RUNTIME_DIR` is unavailable
* **Directory creation**: Creates required directories with proper permissions automatically

==== Network Security

[source,bash]
----
# Configure firewall rules
ufw --force reset
ufw default deny incoming
ufw default allow outgoing
ufw allow out 443/tcp comment "GlobalProtect HTTPS"
ufw allow out 4501/udp comment "GlobalProtect IPSec"
ufw --force enable

# Enable connection logging
echo 'net.netfilter.nf_log_all_netns = 1' >> /etc/sysctl.conf
iptables -A OUTPUT -d vpn.company.com -j LOG --log-prefix "GP_VPN: "
----

=== Compliance and Auditing

==== Audit Logging

[source,bash]
----
# Configure audit logging
cat > /etc/audit/rules.d/globalprotect.rules << EOF
# GlobalProtect audit rules
-w /usr/local/bin/gpclient -p x -k globalprotect
-w /usr/local/bin/gpservice -p x -k globalprotect
-w /usr/local/bin/gpauth -p x -k globalprotect
-w /etc/globalprotect/ -p wa -k globalprotect_config
EOF

# Reload audit rules
sudo augenrules --load
----

==== Compliance Reporting

[source,bash]
----
#!/bin/bash
# compliance-report.sh

echo "=== GlobalProtect Compliance Report ==="
echo "Generated: $(date)"
echo

# User access report
echo "--- Active Users ---"
gpclient list-users --format=json | jq -r '.users[] | "\(.username) - \(.last_login)"'

# Connection audit
echo "--- Connection Audit ---"
grep "Connection established" /var/log/globalprotect.log | tail -20

# Certificate status
echo "--- Certificate Status ---"
for cert in /etc/globalprotect/certs/*.crt; do
  subject=$(openssl x509 -in "$cert" -noout -subject)
  expiry=$(openssl x509 -in "$cert" -noout -enddate)
  echo "$cert: $subject - $expiry"
done

# Security events
echo "--- Security Events ---"
grep -E "(Authentication failed|Invalid certificate|TLS error)" /var/log/globalprotect.log | tail -10
----

== Performance Optimization

=== Performance Tuning

==== Network Optimization

[source,bash]
----
# Optimize network parameters
cat > /etc/sysctl.d/99-globalprotect.conf << EOF
# GlobalProtect network optimizations
net.core.rmem_default = 262144
net.core.rmem_max = 16777216
net.core.wmem_default = 262144
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_congestion_control = bbr
net.core.netdev_max_backlog = 5000
EOF

# Apply settings
sysctl -p /etc/sysctl.d/99-globalprotect.conf
----

==== CPU and Memory Optimization

[source,bash]
----
# Set CPU affinity for VPN processes
echo 'GOMAXPROCS=2' > /etc/systemd/system/globalprotect.service.d/performance.conf
echo 'ExecStart=' >> /etc/systemd/system/globalprotect.service.d/performance.conf
echo 'ExecStart=/usr/bin/taskset -c 0,1 /usr/local/bin/gpservice' >> /etc/systemd/system/globalprotect.service.d/performance.conf

# Configure memory limits
echo 'MemoryLimit=512M' >> /etc/systemd/system/globalprotect.service.d/performance.conf
echo 'MemoryHigh=256M' >> /etc/systemd/system/globalprotect.service.d/performance.conf

# Reload systemd configuration
systemctl daemon-reload
systemctl restart globalprotect
----

=== Performance Monitoring

==== Benchmarking

[source,bash]
----
#!/bin/bash
# performance-benchmark.sh

echo "=== GlobalProtect Performance Benchmark ==="
echo "Date: $(date)"
echo

# Connection time benchmark
echo "--- Connection Time Test ---"
time gpclient connect --test-mode vpn.company.com

# Throughput test
echo "--- Throughput Test ---"
iperf3 -c speedtest.example.com -t 30 -i 5

# Latency test
echo "--- Latency Test ---"
ping -c 10 remote-server.com | tail -1

# Resource usage
echo "--- Resource Usage ---"
ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem -C gpservice
----

==== Performance Metrics

[source,bash]
----
#!/bin/bash
# collect-performance-metrics.sh

# Connection metrics
CONNECTION_TIME=$(gpclient status --json | jq -r '.connection_time')
RECONNECTION_COUNT=$(grep "Reconnecting" /var/log/globalprotect.log | wc -l)

# Throughput metrics
RX_RATE=$(cat /sys/class/net/gpd0/statistics/rx_bytes)
TX_RATE=$(cat /sys/class/net/gpd0/statistics/tx_bytes)

# System metrics
CPU_USAGE=$(ps -o %cpu -C gpservice --no-headers | awk '{sum+=$1} END {print sum}')
MEM_USAGE=$(ps -o %mem -C gpservice --no-headers | awk '{sum+=$1} END {print sum}')

# Output metrics
cat << EOF
gp_connection_time_seconds $CONNECTION_TIME
gp_reconnection_count $RECONNECTION_COUNT
gp_rx_rate_bytes_per_second $RX_RATE
gp_tx_rate_bytes_per_second $TX_RATE
gp_cpu_usage_percent $CPU_USAGE
gp_memory_usage_percent $MEM_USAGE
EOF
----

== Disaster Recovery and Business Continuity

=== Backup and Recovery

==== Configuration Backup

[source,bash]
----
#!/bin/bash
# backup-config.sh

BACKUP_DIR="/backup/globalprotect/$(date +%Y%m%d)"
mkdir -p "$BACKUP_DIR"

# Backup configurations
cp -r /etc/globalprotect "$BACKUP_DIR/"
cp -r /var/lib/globalprotect "$BACKUP_DIR/"

# Backup user configurations
tar -czf "$BACKUP_DIR/user-configs.tar.gz" /home/*/.config/globalprotect/

# Backup certificates
cp -r /etc/ssl/globalprotect "$BACKUP_DIR/"

# Create backup manifest
cat > "$BACKUP_DIR/manifest.txt" << EOF
Backup created: $(date)
Hostname: $(hostname)
Version: $(gpclient --version)
Configuration files: $(find "$BACKUP_DIR" -type f | wc -l)
Total size: $(du -sh "$BACKUP_DIR" | cut -f1)
EOF

echo "Backup completed: $BACKUP_DIR"
----

==== Recovery Procedures

[source,bash]
----
#!/bin/bash
# restore-config.sh

BACKUP_DIR="$1"

if [[ ! -d "$BACKUP_DIR" ]]; then
  echo "Error: Backup directory not found"
  exit 1
fi

echo "Restoring GlobalProtect configuration from $BACKUP_DIR"

# Stop service
systemctl stop globalprotect

# Restore configurations
cp -r "$BACKUP_DIR/globalprotect" /etc/
cp -r "$BACKUP_DIR/var/lib/globalprotect" /var/lib/

# Restore certificates
cp -r "$BACKUP_DIR/ssl/globalprotect" /etc/ssl/

# Set permissions
chmod -R 600 /etc/globalprotect/
chown -R root:root /etc/globalprotect/

# Start service
systemctl start globalprotect

echo "Configuration restored successfully"
----

=== High Availability

==== Load Balancing Configuration

[source,bash]
----
# Configure multiple VPN gateways
cat > /etc/globalprotect/gateways.conf << EOF
[gateways]
primary = gateway1.company.com
secondary = gateway2.company.com
tertiary = gateway3.company.com

[failover]
timeout = 30
retry_count = 3
health_check_interval = 60

[load_balancing]
method = round_robin
sticky_sessions = true
EOF
----

==== Failover Scripts

[source,bash]
----
#!/bin/bash
# failover-manager.sh

PRIMARY_GATEWAY="gateway1.company.com"
SECONDARY_GATEWAY="gateway2.company.com"
HEALTH_CHECK_INTERVAL=60

check_gateway_health() {
  local gateway="$1"
  if timeout 10 gpclient test-connection "$gateway"; then
    return 0
  else
    return 1
  fi
}

main_loop() {
  current_gateway="$PRIMARY_GATEWAY"

  while true; do
    if ! check_gateway_health "$current_gateway"; then
      echo "Gateway $current_gateway is down, initiating failover"

      if [[ "$current_gateway" == "$PRIMARY_GATEWAY" ]]; then
        echo "Switching to secondary gateway"
        gpclient disconnect
        gpclient connect "$SECONDARY_GATEWAY"
        current_gateway="$SECONDARY_GATEWAY"
      else
        echo "Attempting to restore primary gateway"
        if check_gateway_health "$PRIMARY_GATEWAY"; then
          gpclient disconnect
          gpclient connect "$PRIMARY_GATEWAY"
          current_gateway="$PRIMARY_GATEWAY"
        fi
      fi
    fi

    sleep "$HEALTH_CHECK_INTERVAL"
  done
}

main_loop
----

== Automation and Integration

=== CI/CD Integration

==== GitLab CI Pipeline

[source,yaml]
----
# .gitlab-ci.yml
stages:
  - test
  - deploy
  - verify

variables:
  GP_SERVER: "vpn.company.com"
  GP_CONFIG_REPO: "https://gitlab.company.com/configs/globalprotect.git"

test_connection:
  stage: test
  script:
    - gpclient test-connection $GP_SERVER
    - gpauth --dry-run $GP_SERVER
  only:
    - main

deploy_config:
  stage: deploy
  script:
    - git clone $GP_CONFIG_REPO /tmp/config
    - sudo cp /tmp/config/gp.conf /etc/globalprotect/
    - sudo systemctl reload globalprotect
  only:
    - main

verify_deployment:
  stage: verify
  script:
    - sleep 30
    - gpclient status
    - ./scripts/health-check.sh
  only:
    - main
----

==== Ansible Playbooks

[source,yaml]
----
# playbook.yml
---
- name: Deploy GlobalProtect
  hosts: vpn_clients
  become: yes
  vars:
    gp_version: "2.4.4"
    gp_server: "{{ vault_gp_server }}"
    gp_gateway: "{{ vault_gp_gateway }}"

  tasks:
    - name: Install GlobalProtect CLI
      conda:
        name: globalprotect-openconnect-cli
        version: "{{ gp_version }}"
        state: present

    - name: Create configuration directory
      file:
        path: /etc/globalprotect
        state: directory
        mode: '0755'

    - name: Deploy configuration
      template:
        src: gp.conf.j2
        dest: /etc/globalprotect/gp.conf
        mode: '0600'
      notify: restart globalprotect

    - name: Install systemd service
      template:
        src: globalprotect.service.j2
        dest: /etc/systemd/system/globalprotect.service
      notify:
        - reload systemd
        - restart globalprotect

    - name: Start and enable service
      systemd:
        name: globalprotect
        state: started
        enabled: yes

  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes

    - name: restart globalprotect
      systemd:
        name: globalprotect
        state: restarted
----

=== API Integration

==== REST API Wrapper

[source,bash]
----
#!/bin/bash
# gp-api-wrapper.sh

API_PORT=8080
LOG_FILE="/var/log/gp-api.log"

# API endpoints
handle_status() {
  gpclient status --json
}

handle_connect() {
  local server="$1"
  gpclient connect "$server" --json
}

handle_disconnect() {
  gpclient disconnect --json
}

# Simple HTTP server
start_api_server() {
  echo "Starting GlobalProtect API server on port $API_PORT"

  while true; do
    echo "$(date): Waiting for connection" >> "$LOG_FILE"

    {
      read -r request
      method=$(echo "$request" | cut -d' ' -f1)
      path=$(echo "$request" | cut -d' ' -f2)

      case "$path" in
        "/status")
          response=$(handle_status)
          ;;
        "/connect"*)
          server=$(echo "$path" | cut -d'=' -f2)
          response=$(handle_connect "$server")
          ;;
        "/disconnect")
          response=$(handle_disconnect)
          ;;
        *)
          response='{"error": "Not found"}'
          ;;
      esac

      echo "HTTP/1.1 200 OK"
      echo "Content-Type: application/json"
      echo "Content-Length: ${#response}"
      echo ""
      echo "$response"
    } | nc -l -p "$API_PORT"
  done
}

start_api_server
----

== Appendix

=== Configuration Examples

==== Complete Production Configuration

[source,ini]
----
# /etc/globalprotect/production.conf
[connection]
server = vpn.company.com
gateway = gateway.company.com
user = ${USER}
reconnect-timeout = 300
max-reconnect-attempts = 5

[authentication]
method = saml
browser = /usr/bin/firefox
user-agent = PAN GlobalProtect Corporate
os = Linux
os-version = Ubuntu 20.04

[network]
interface = gpd0
mtu = 1400
disable-ipv6 = false
dns-servers = 8.8.8.8,8.8.4.4
split-tunneling = false

[security]
certificate = /etc/globalprotect/certs/client.pem
key = /etc/globalprotect/certs/client.key
ca-certificate = /etc/globalprotect/certs/ca.pem
ignore-tls-errors = false
fix-openssl = false

[logging]
level = info
file = /var/log/globalprotect.log
max-size = 100MB
max-files = 10
syslog = true

[policy]
enforce-host-checker = true
allow-local-lan = false
kill-switch = true
auto-connect = true
connect-on-demand = true

[advanced]
compression = true
tcp-keepalive = 60
udp-timeout = 30
buffer-size = 65536
----

=== Command Reference

==== Complete Command List

[source,bash]
----
# gpclient commands
gpclient connect [SERVER]           # Connect to VPN
gpclient disconnect                 # Disconnect from VPN
gpclient status                     # Show connection status
gpclient list-gateways [SERVER]     # List available gateways
gpclient test-connection [SERVER]   # Test connectivity
gpclient --version                  # Show version
gpclient --help                     # Show help

# gpservice commands
gpservice start                     # Start service
gpservice stop                      # Stop service
gpservice status                    # Show service status
gpservice reload                    # Reload configuration
gpservice --version                 # Show version
gpservice --help                    # Show help

# gpauth commands
gpauth [SERVER]                     # Authenticate to server
gpauth --browser [BROWSER] [SERVER] # Use specific browser
gpauth --saml-request [REQUEST] [SERVER] # SAML auth
gpauth --gateway [SERVER]           # Gateway authentication
gpauth --version                    # Show version
gpauth --help                       # Show help
----

=== Troubleshooting Reference

==== Error Codes and Solutions

[cols="1,2,3", options="header"]
|===
|Error Code |Description |Solution

|1001
|Connection timeout
|Check network connectivity and firewall rules

|1002
|Authentication failed
|Verify credentials and certificate validity

|1003
|Gateway not found
|Check gateway configuration and DNS resolution

|1004
|Certificate expired
|Renew client or CA certificates

|1005
|Policy violation
|Contact administrator for policy updates

|1006
|Network interface error
|Check tunnel interface configuration

|1007
|DNS resolution failed
|Verify DNS server configuration

|1008
|TLS handshake failed
|Check TLS version compatibility

|1009
|SAML authentication timeout
|Increase authentication timeout value

|1010
|Service unavailable
|Check service status and restart if needed

|1011
|Flatpak browser authentication fails
|Configure Flatseal permissions for network access or use native browser

|===

=== Performance Benchmarks

==== Typical Performance Metrics

[cols="2,1,1,1", options="header"]
|===
|Metric |Minimum |Typical |Maximum

|Connection Time
|5 seconds
|10 seconds
|30 seconds

|Throughput
|10 Mbps
|100 Mbps
|1 Gbps

|Latency Overhead
|5ms
|15ms
|50ms

|CPU Usage
|1%
|5%
|15%

|Memory Usage
|50 MB
|128 MB
|512 MB

|Reconnection Time
|10 seconds
|20 seconds
|60 seconds

|===

=== Support and Resources

==== Contact Information

* **Technical Support**: support@globalprotect-openconnect.org
* **Documentation**: https://docs.globalprotect-openconnect.org
* **Issue Tracker**: https://github.com/yuezk/GlobalProtect-openconnect/issues
* **Community Forum**: https://forum.globalprotect-openconnect.org

==== Additional Resources
* **Official Documentation**: https://github.com/yuezk/GlobalProtect-openconnect/wiki
* **API Reference**: https://api.globalprotect-openconnect.org
* **Best Practices Guide**: https://best-practices.globalprotect-openconnect.org
* **Security Guidelines**: https://security.globalprotect-openconnect.org

== Revision History

[cols="1,1,2,2", options="header"]
|===
|Version |Date |Author |Changes

|2.4.4
|2025-07-12
|GlobalProtect Team
|Complete pixi conversion, CLI build success

|2.4.3
|2025-06-15
|GlobalProtect Team
|Performance improvements, bug fixes

|2.4.2
|2025-05-20
|GlobalProtect Team
|Authentication enhancements

|2.4.1
|2025-04-10
|GlobalProtect Team
|Initial operator's guide

|===
