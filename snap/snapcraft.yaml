name: globalprotect-openconnect
base: core18
version: 'test'
summary: A GlobalProtect VPN client powered by OpenConnect
description: |
  A GlobalProtect VPN client (GUI) for Linux based on OpenConnect and built with Qt5, supports SAML auth mode.

grade: devel
confinement: devmode # use 'strict' once you have the right plugs and slots

package-repositories:
  - type: apt
    ppa: dwmw2/openconnect

layout:
  /usr/share/vpnc-scripts:
    bind: $SNAP/usr/share/vpnc-scripts
  /usr/local/sbin:
    bind: $SNAP/usr/local/sbin
  /usr/share/qt5:
    bind: $SNAP/usr/share/qt5

slots:
  gpservice-slot:
    interface: dbus
    bus: system
    name: com.yuezk.qt.GPService

plugs:
  gpservice-plug:
    interface: dbus
    bus: system
    name: com.yuezk.qt.GPService

apps:
  gpservice:
    # daemon: simple
    command: usr/bin/gpservice
    extensions:
      - kde-neon
    environment:
      LANG: en_US.utf8
    plugs:
      - network
    slots: 
      - gpservice-slot

  gpclient:
    common-id: com.yuezk.qt.gpclient
    command: usr/bin/gpclient
    desktop: usr/share/applications/com.yuezk.qt.gpclient.desktop
    extensions:
      - kde-neon
    plugs:
      - desktop
      - desktop-legacy
      - wayland
      - unity7
      - x11
      - network
      - gpservice-plug

parts:
  application:
    plugin: nil
    source: .
    build-snaps:
      - kde-frameworks-5-core18-sdk
    stage-snaps:
      - kde-frameworks-5-core18
    stage-packages:
      - openconnect
    override-build: |
      KF5_DIR=/snap/kde-frameworks-5-core18-sdk/current

      export QTDIR=$KF5_DIR/usr/lib/qt5
      export PATH=$QTDIR/bin:$KF5_DIR/usr/bin:$PATH
      export LD_LIBRARY_PATH=$KF5_DIR/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$QTDIR/lib:$LD_LIBRARY_PATH
      export PKG_CONFIG_PATH=$QTDIR/lib/pkgconfig:$PKG_CONFIG_PATH
      export QMAKESPEC=$KF5_DIR/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/qt5/mkspecs/linux-g++
      # export QT_SELECT=qt5

      qmake CONFIG+=release # -qtconf $KF5_DIR/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/qt5/qt.conf
      make -j$(nproc)
      make INSTALL_ROOT=$SNAPCRAFT_PART_INSTALL install
