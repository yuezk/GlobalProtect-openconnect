From a8d5ec198ca9ae47a0e6b4f1ea244d2738acf055 Mon Sep 17 00:00:00 2001
From: Kevin Yue <yuezk001@gmail.com>
Date: Sun, 14 Dec 2025 17:10:02 +0800
Subject: [PATCH 1/4] Add support for GlobalProtect app version handling

- Introduced `gp_app_version` field in `openconnect_info` structure.
- Implemented `openconnect_set_gp_app_version` and `openconnect_get_gp_app_version` functions.
- Updated `gpst_get_config` to use the app version in requests.
- Free `gp_app_version` in `openconnect_vpninfo_free` to prevent memory leaks.
---
 gpst.c                 |  8 +++++---
 library.c              | 15 +++++++++++++++
 openconnect-internal.h |  4 ++++
 openconnect.h          |  2 ++
 4 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/gpst.c b/gpst.c
index 244aaf04..5c24bbd2 100644
--- a/gpst.c
+++ b/gpst.c
@@ -650,8 +650,11 @@ static int gpst_get_config(struct openconnect_info *vpninfo)
 
 
 	/* submit getconfig request */
+	const char *app_version = openconnect_get_gp_app_version(vpninfo);
+	vpn_progress(vpninfo, PRG_DEBUG, _("Using GlobalProtect app version: %s\n"), app_version);
+
 	buf_append(request_body, "client-type=1&protocol-version=p1&internal=no");
-	append_opt(request_body, "app-version", vpninfo->csd_ticket ? : "6.3.0-33");
+	append_opt(request_body, "app-version", app_version);
 	append_opt(request_body, "ipv6-support", vpninfo->disable_ipv6 ? "no" : "yes");
 	append_opt(request_body, "clientos", gpst_os_name(vpninfo));
 	append_opt(request_body, "os-version", vpninfo->platname);
@@ -1040,8 +1043,7 @@ static int run_hip_script(struct openconnect_info *vpninfo)
 		 * accept new ones.
 		 */
 		unsetenv("APP_VERSION");
-		if (vpninfo->csd_ticket)
-			if (setenv("APP_VERSION", vpninfo->csd_ticket, 1))
+		if (setenv("APP_VERSION", openconnect_get_gp_app_version(vpninfo), 1))
 				goto out;
 
 		execv(hip_argv[0], (char **)hip_argv);
diff --git a/library.c b/library.c
index b5e74e9b..18334c76 100644
--- a/library.c
+++ b/library.c
@@ -896,6 +896,7 @@ void openconnect_vpninfo_free(struct openconnect_info *vpninfo)
 
 	free(vpninfo->localname);
 	free(vpninfo->useragent);
+	free(vpninfo->gp_app_version);
 	free(vpninfo->authgroup);
 #ifdef HAVE_LIBSTOKEN
 	if (vpninfo->stoken_pin)
@@ -1019,6 +1020,20 @@ int openconnect_set_useragent(struct openconnect_info *vpninfo,
 	return 0;
 }
 
+int openconnect_set_gp_app_version(struct openconnect_info *vpninfo,
+				   const char *gp_app_version)
+{
+	UTF8CHECK(gp_app_version);
+
+	STRDUP(vpninfo->gp_app_version, gp_app_version);
+	return 0;
+}
+
+const char *openconnect_get_gp_app_version(struct openconnect_info *vpninfo)
+{
+	return vpninfo->csd_ticket ?: (vpninfo->gp_app_version ?: "6.3.0-33");
+}
+
 int openconnect_set_urlpath(struct openconnect_info *vpninfo,
 			    const char *urlpath)
 {
diff --git a/openconnect-internal.h b/openconnect-internal.h
index abf45bbd..988f85f0 100644
--- a/openconnect-internal.h
+++ b/openconnect-internal.h
@@ -786,6 +786,7 @@ struct openconnect_info {
 	int is_dyndns; /* Attempt to redo DNS lookup on each CSTP reconnect */
 	char *useragent;
 	char *version_string;
+	char *gp_app_version;
 
 	const char *quit_reason;
 	const char *delay_tunnel_reason;        /* If non-null, provides a reason why protocol is not yet ready for tunnel setup */
@@ -1677,6 +1678,9 @@ void openconnect_set_juniper(struct openconnect_info *vpninfo);
 /* hpke.c */
 int handle_external_browser(struct openconnect_info *vpninfo);
 
+/* Get the app version */
+const char *openconnect_get_gp_app_version(struct openconnect_info *vpninfo);
+
 /* version.c */
 extern const char openconnect_version_str[];
 
diff --git a/openconnect.h b/openconnect.h
index 136f181a..7d4f3399 100644
--- a/openconnect.h
+++ b/openconnect.h
@@ -470,6 +470,8 @@ int openconnect_set_http_proxy(struct openconnect_info *vpninfo,
 int openconnect_set_useragent(struct openconnect_info *vpninfo,
 			      const char *useragent);
 
+int openconnect_set_gp_app_version(struct openconnect_info *vpninfo,
+				   const char *gp_app_version);
 int openconnect_passphrase_from_fsid(struct openconnect_info *vpninfo);
 int openconnect_obtain_cookie(struct openconnect_info *vpninfo);
 int openconnect_init_ssl(void);
-- 
2.50.1 (Apple Git-155)

