#!/bin/bash

# OpenConnect GlobalProtect Wrapper with Version Override
# This script allows easy overriding of the GlobalProtect app version

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
OVERRIDE_LIB="$PROJECT_ROOT/gp_version_override.so"

# Default to a modern, compatible version
DEFAULT_GP_VERSION="6.3.0"

# Show usage information
usage() {
    cat << 'USAGE_EOF'
OpenConnect GlobalProtect Wrapper with Version Override

Usage:
  openconnect-gp [options] <server>
  openconnect-gp --gp-version=VERSION [options] <server>

GlobalProtect Version Options:
  --gp-version=VERSION    Set GlobalProtect app version (default: 6.3.0)
                          Common values: 6.1.4, 6.2.0, 6.3.0, 6.3.3

Environment Variables:
  GP_APP_VERSION          Override the GlobalProtect version
                          (command line --gp-version takes precedence)

Examples:
  # Use default version (6.3.0)
  openconnect-gp vpn.company.com

  # Specify version on command line
  openconnect-gp --gp-version=6.1.4 vpn.company.com

  # Use environment variable
  GP_APP_VERSION=6.2.0 openconnect-gp vpn.company.com

  # Pass additional OpenConnect options
  openconnect-gp --gp-version=6.3.0 --user=john vpn.company.com

All other options are passed directly to openconnect.
USAGE_EOF
}

# Check if override library exists
if [ ! -f "$OVERRIDE_LIB" ]; then
    echo "ERROR: Override library not found at $OVERRIDE_LIB"
    echo "Please run: pixi run create-gp-version-override"
    exit 1
fi

# Parse command line arguments
GP_VERSION=""
OPENCONNECT_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --gp-version=*)
            GP_VERSION="${1#*=}"
            shift
            ;;
        --gp-version)
            GP_VERSION="$2"
            shift 2
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            OPENCONNECT_ARGS+=("$1")
            shift
            ;;
    esac
done

# Determine which version to use
if [ -n "$GP_VERSION" ]; then
    # Command line version takes precedence
    export GP_APP_VERSION="$GP_VERSION"
elif [ -z "$GP_APP_VERSION" ]; then
    # No version specified, use default
    export GP_APP_VERSION="$DEFAULT_GP_VERSION"
fi

echo "Using GlobalProtect app version: $GP_APP_VERSION"

# Add --protocol=gp if not already present
PROTOCOL_SET=false
for arg in "${OPENCONNECT_ARGS[@]}"; do
    if [[ "$arg" == "--protocol=gp" ]] || [[ "$arg" == "--protocol"* ]]; then
        PROTOCOL_SET=true
        break
    fi
done

if [ "$PROTOCOL_SET" = false ]; then
    OPENCONNECT_ARGS=("--protocol=gp" "${OPENCONNECT_ARGS[@]}")
fi

# Run openconnect with our override library
echo "Running: LD_PRELOAD=$OVERRIDE_LIB openconnect ${OPENCONNECT_ARGS[*]}"
echo ""

LD_PRELOAD="$OVERRIDE_LIB" openconnect "${OPENCONNECT_ARGS[@]}"
